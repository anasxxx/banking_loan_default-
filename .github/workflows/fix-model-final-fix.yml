name: Fix Model Loading - FINAL FIX

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fix-model:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 0
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Upload model files
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/models/production"
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/lightgbm_smote_high_performance.pkl ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/metrics_smote_high_performance.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/optimal_threshold_smote.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/feature_names.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/
      
      - name: Diagnose and fix completely
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            echo "=========================================="
            echo "DIAGNOSTIC: Check ALL containers"
            echo "=========================================="
            echo "All running containers:"
            docker ps
            echo ""
            echo "All containers (including stopped):"
            docker ps -a
            echo ""
            echo "Containers using port 8000:"
            docker ps --filter "publish=8000"
            echo ""
            echo "All containers with 'loan' in name:"
            docker ps -a | grep -i loan || echo "None found"
            
            echo ""
            echo "=========================================="
            echo "STEP 1: STOP EVERYTHING"
            echo "=========================================="
            # Stop ALL containers
            docker stop $(docker ps -q) 2>&1 || echo "No containers to stop"
            sleep 5
            
            echo ""
            echo "=========================================="
            echo "STEP 2: REMOVE EVERYTHING"
            echo "=========================================="
            # Remove ALL containers
            docker rm -f $(docker ps -aq) 2>&1 || echo "No containers to remove"
            sleep 3
            
            # Verify nothing is running
            if [ $(docker ps -q | wc -l) -gt 0 ]; then
              echo "WARNING: Containers still running!"
              docker ps
              docker stop $(docker ps -q) 2>&1 || true
              docker rm -f $(docker ps -aq) 2>&1 || true
              sleep 3
            fi
            
            echo "✓ All containers stopped and removed"
            
            echo ""
            echo "=========================================="
            echo "STEP 3: Verify model files exist"
            echo "=========================================="
            MODELS_ABS=$(cd ~/models && pwd)
            echo "Models path: $MODELS_ABS"
            ls -lah $MODELS_ABS/production/
            
            if [ ! -f $MODELS_ABS/production/lightgbm_smote_high_performance.pkl ]; then
              echo "✗ ERROR: Model file NOT FOUND at $MODELS_ABS/production/"
              exit 1
            fi
            echo "✓ Model file exists: $(ls -lh $MODELS_ABS/production/lightgbm_smote_high_performance.pkl)"
            
            echo ""
            echo "=========================================="
            echo "STEP 4: Start ONE container with NO restart policy"
            echo "=========================================="
            # Start WITHOUT --restart to prevent Docker from auto-restarting old containers
            CONTAINER_ID=$(docker run -d -p 8000:8000 \
              -v $MODELS_ABS:/app/models:ro \
              --name loan-api \
              ${{ secrets.DOCKERHUB_USERNAME }}/loan-api:latest)
            
            echo "Container ID: $CONTAINER_ID"
            
            echo ""
            echo "=========================================="
            echo "STEP 5: Wait for startup"
            echo "=========================================="
            sleep 10
            
            echo ""
            echo "=========================================="
            echo "STEP 6: Check container status"
            echo "=========================================="
            docker ps -a | grep loan-api || echo "Container not found!"
            if [ $(docker ps | grep loan-api | wc -l) -eq 0 ]; then
              echo "✗ ERROR: Container is not running!"
              echo "Container logs:"
              docker logs $CONTAINER_ID 2>&1 || docker logs loan-api 2>&1 || echo "Cannot get logs"
              exit 1
            fi
            echo "✓ Container is running"
            
            echo ""
            echo "=========================================="
            echo "STEP 7: Get container logs"
            echo "=========================================="
            docker logs loan-api 2>&1 | tail -100
            
            echo ""
            echo "=========================================="
            echo "STEP 8: Verify model in container"
            echo "=========================================="
            docker exec loan-api ls -lah /app/models/production/ 2>&1 || echo "Cannot exec"
            docker exec loan-api test -f /app/models/production/lightgbm_smote_high_performance.pkl && echo "✓ Model file accessible" || echo "✗ Model file NOT accessible"
            
            echo ""
            echo "=========================================="
            echo "STEP 9: Wait for model to fully load"
            echo "=========================================="
            sleep 30
            
            echo ""
            echo "=========================================="
            echo "STEP 10: Test API from INSIDE EC2"
            echo "=========================================="
            echo "Health check:"
            HEALTH=$(curl -s http://localhost:8000/health)
            echo "$HEALTH"
            echo ""
            if echo "$HEALTH" | grep -q '"model_loaded":true'; then
              echo "✓ Model is loaded according to health check"
            else
              echo "✗ Model NOT loaded according to health check"
            fi
            
            echo ""
            echo "Model info:"
            MODEL_INFO=$(curl -s http://localhost:8000/model/info)
            echo "$MODEL_INFO"
            echo ""
            if echo "$MODEL_INFO" | grep -q '"model_type"'; then
              echo "✓ Model info endpoint working"
            else
              echo "✗ Model info endpoint failed"
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 11: Verify only ONE container"
            echo "=========================================="
            CONTAINER_COUNT=$(docker ps | grep -c loan-api || echo "0")
            echo "Running loan-api containers: $CONTAINER_COUNT"
            if [ "$CONTAINER_COUNT" != "1" ]; then
              echo "WARNING: Expected 1 container, found $CONTAINER_COUNT"
              docker ps | grep loan-api
            else
              echo "✓ Only ONE container is running"
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 12: Check what's actually on port 8000"
            echo "=========================================="
            PORT_CONTAINER=$(docker ps --filter "publish=8000" --format "{{.ID}}")
            echo "Container on port 8000: $PORT_CONTAINER"
            if [ -n "$PORT_CONTAINER" ]; then
              echo "Container name: $(docker ps --filter "id=$PORT_CONTAINER" --format "{{.Names}}")"
              echo "Container logs (last 20 lines):"
              docker logs $PORT_CONTAINER 2>&1 | tail -20
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 13: Final test - make actual prediction"
            echo "=========================================="
            PRED_TEST=$(curl -s -X POST http://localhost:8000/predict \
              -H "Content-Type: application/json" \
              -d '{"AMT_INCOME_TOTAL": 180000.0, "AMT_CREDIT": 450000.0, "AMT_ANNUITY": 22500.0, "AMT_GOODS_PRICE": 420000.0, "DAYS_BIRTH": -12000, "DAYS_EMPLOYED": -4000, "EXT_SOURCE_1": 0.8, "EXT_SOURCE_2": 0.75, "EXT_SOURCE_3": 0.85}' 2>&1)
            echo "$PRED_TEST"
            if echo "$PRED_TEST" | grep -q '"success":true'; then
              echo "✓ Prediction endpoint working!"
            else
              echo "✗ Prediction endpoint failed"
            fi
            
            echo ""
            echo "=========================================="
            echo "COMPLETE - Summary"
            echo "=========================================="
            echo "Container status: $(docker ps | grep loan-api || echo 'NOT RUNNING')"
            echo "Model loaded: $(echo $HEALTH | grep -o '"model_loaded":[^,]*' || echo 'unknown')"
            echo "Port 8000 container: $PORT_CONTAINER"
