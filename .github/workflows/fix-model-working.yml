name: Fix Model Loading - Working Solution

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fix-model:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 0
      
      - name: List files in repository
        run: |
          echo "Checking repository files..."
          ls -lh models/production/ || echo "Directory not found"
          find models/production -type f -name "*smote*" || echo "No SMOTE files found"
          find models/production -type f -name "feature_names.json" || echo "feature_names.json not found"
      
      - name: Upload model files individually to EC2
        uses: appleboy/scp-action@master
        continue-on-error: false
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "models/production/lightgbm_smote_high_performance.pkl"
          target: "~/models/production/"
          rm: false
          strip_components: 0
          overwrite: true
      
      - name: Upload metrics file
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "models/production/metrics_smote_high_performance.json"
          target: "~/models/production/"
          rm: false
          strip_components: 0
          overwrite: true
      
      - name: Upload threshold file
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "models/production/optimal_threshold_smote.json"
          target: "~/models/production/"
          rm: false
          strip_components: 0
          overwrite: true
      
      - name: Upload feature names file
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "models/production/feature_names.json"
          target: "~/models/production/"
          rm: false
          strip_components: 0
          overwrite: true
      
      - name: Fix permissions and restart container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "=========================================="
            echo "STEP 1: Create directory and set permissions"
            echo "=========================================="
            mkdir -p ~/models/production
            chmod -R 755 ~/models/production/
            
            echo ""
            echo "=========================================="
            echo "STEP 2: Verify ALL files exist on EC2"
            echo "=========================================="
            echo "Checking files..."
            ls -lah ~/models/production/ || echo "Directory empty or doesn't exist"
            
            echo ""
            echo "Checking for model file:"
            if [ -f ~/models/production/lightgbm_smote_high_performance.pkl ]; then
              echo "✓ Model file EXISTS: $(ls -lh ~/models/production/lightgbm_smote_high_performance.pkl)"
            else
              echo "✗ ERROR: Model file NOT FOUND!"
              echo "Listing directory contents:"
              ls -la ~/models/production/ 2>&1 || echo "Cannot list directory"
              exit 1
            fi
            
            echo ""
            echo "Checking other files:"
            [ -f ~/models/production/metrics_smote_high_performance.json ] && echo "✓ Metrics file exists" || echo "✗ Metrics file missing"
            [ -f ~/models/production/optimal_threshold_smote.json ] && echo "✓ Threshold file exists" || echo "✗ Threshold file missing"
            [ -f ~/models/production/feature_names.json ] && echo "✓ Feature names file exists" || echo "✗ Feature names file missing"
            
            echo ""
            echo "=========================================="
            echo "STEP 3: Stop and remove old container"
            echo "=========================================="
            docker stop loan-api 2>&1 || echo "Container not running"
            docker rm loan-api 2>&1 || echo "Container not found"
            
            echo ""
            echo "=========================================="
            echo "STEP 4: Start new container"
            echo "=========================================="
            docker run -d -p 8000:8000 \
              -v ~/models:/app/models \
              -v ~/data:/app/data \
              --name loan-api \
              --restart unless-stopped \
              ${{ secrets.DOCKERHUB_USERNAME }}/loan-api:latest
            
            echo ""
            echo "=========================================="
            echo "STEP 5: Wait for container to start"
            echo "=========================================="
            sleep 30
            
            echo ""
            echo "=========================================="
            echo "STEP 6: Check container status"
            echo "=========================================="
            docker ps | grep loan-api || echo "Container not running!"
            
            echo ""
            echo "=========================================="
            echo "STEP 7: Check container logs"
            echo "=========================================="
            docker logs loan-api --tail 100
            
            echo ""
            echo "=========================================="
            echo "STEP 8: Verify file in container"
            echo "=========================================="
            docker exec loan-api ls -la /app/models/production/ 2>&1 || echo "Cannot access container"
            docker exec loan-api test -f /app/models/production/lightgbm_smote_high_performance.pkl && echo "✓ Model file accessible in container" || echo "✗ Model file NOT accessible in container"
            
            echo ""
            echo "=========================================="
            echo "STEP 9: Test API endpoints"
            echo "=========================================="
            sleep 5
            curl -v http://localhost:8000/health 2>&1 || echo "Health check failed"
            curl -v http://localhost:8000/model/info 2>&1 || echo "Model info check failed"
            
            echo ""
            echo "=========================================="
            echo "FIX COMPLETE"
            echo "=========================================="
