name: Fix Model Loading - Working Solution

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fix-model:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 0
      
      - name: List files in repository
        run: |
          echo "Checking repository files..."
          ls -lh models/production/ || echo "Directory not found"
          find models/production -type f -name "*smote*" || echo "No SMOTE files found"
          find models/production -type f -name "feature_names.json" || echo "feature_names.json not found"
      
      - name: Verify model file exists and get size
        run: |
          echo "Checking model file..."
          if [ -f "models/production/lightgbm_smote_high_performance.pkl" ]; then
            echo "✓ Model file exists"
            ls -lh models/production/lightgbm_smote_high_performance.pkl
            echo "File size: $(stat -f%z models/production/lightgbm_smote_high_performance.pkl 2>/dev/null || stat -c%s models/production/lightgbm_smote_high_performance.pkl 2>/dev/null || echo 'unknown') bytes"
          else
            echo "✗ Model file NOT FOUND in repository!"
            exit 1
          fi
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Upload all model files using SCP
        run: |
          echo "Uploading model files to EC2..."
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/models/production"
          
          echo "Uploading model file (52MB)..."
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/lightgbm_smote_high_performance.pkl ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/ || { echo "Model file upload failed!"; exit 1; }
          
          echo "Uploading metrics file..."
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/metrics_smote_high_performance.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/ || { echo "Metrics file upload failed!"; exit 1; }
          
          echo "Uploading threshold file..."
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/optimal_threshold_smote.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/ || { echo "Threshold file upload failed!"; exit 1; }
          
          echo "Uploading feature names file..."
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/feature_names.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/models/production/ || { echo "Feature names file upload failed!"; exit 1; }
          
          echo "All files uploaded successfully!"
      
      - name: Verify all files uploaded
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "=========================================="
            echo "Verifying all uploaded files..."
            echo "=========================================="
            echo "Files in ~/models/production/:"
            ls -lah ~/models/production/
            
            echo ""
            echo "Checking each file:"
            missing=0
            
            if [ -f ~/models/production/lightgbm_smote_high_performance.pkl ]; then
              echo "✓ Model file exists: $(ls -lh ~/models/production/lightgbm_smote_high_performance.pkl | awk '{print $5, $9}')"
            else
              echo "✗ Model file missing!"
              missing=1
            fi
            
            if [ -f ~/models/production/metrics_smote_high_performance.json ]; then
              echo "✓ Metrics file exists"
            else
              echo "✗ Metrics file missing!"
              missing=1
            fi
            
            if [ -f ~/models/production/optimal_threshold_smote.json ]; then
              echo "✓ Threshold file exists"
            else
              echo "✗ Threshold file missing!"
              missing=1
            fi
            
            if [ -f ~/models/production/feature_names.json ]; then
              echo "✓ Feature names file exists"
            else
              echo "✗ Feature names file missing!"
              missing=1
            fi
            
            if [ $missing -eq 1 ]; then
              echo ""
              echo "ERROR: Some files are missing!"
              exit 1
            else
              echo ""
              echo "✓ All files verified successfully!"
            fi
      
      - name: Fix permissions and restart container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "=========================================="
            echo "STEP 1: Create directory and set permissions"
            echo "=========================================="
            mkdir -p ~/models/production
            chmod -R 755 ~/models/production/
            
            echo ""
            echo "=========================================="
            echo "STEP 2: Verify ALL files exist on EC2"
            echo "=========================================="
            echo "Checking files..."
            ls -lah ~/models/production/ || echo "Directory empty or doesn't exist"
            
            echo ""
            echo "Checking for model file:"
            if [ -f ~/models/production/lightgbm_smote_high_performance.pkl ]; then
              echo "✓ Model file EXISTS: $(ls -lh ~/models/production/lightgbm_smote_high_performance.pkl)"
            else
              echo "✗ ERROR: Model file NOT FOUND!"
              echo "Listing directory contents:"
              ls -la ~/models/production/ 2>&1 || echo "Cannot list directory"
              exit 1
            fi
            
            echo ""
            echo "Checking other files:"
            [ -f ~/models/production/metrics_smote_high_performance.json ] && echo "✓ Metrics file exists" || echo "✗ Metrics file missing"
            [ -f ~/models/production/optimal_threshold_smote.json ] && echo "✓ Threshold file exists" || echo "✗ Threshold file missing"
            [ -f ~/models/production/feature_names.json ] && echo "✓ Feature names file exists" || echo "✗ Feature names file missing"
            
            echo ""
            echo "=========================================="
            echo "STEP 3: Stop and remove ALL old containers"
            echo "=========================================="
            # Stop all loan-api containers
            docker stop loan-api 2>&1 || echo "No container to stop"
            sleep 2
            
            # Force remove all loan-api containers (running or stopped)
            docker rm -f loan-api 2>&1 || echo "No container to remove"
            sleep 2
            
            # Make absolutely sure - remove by name pattern if needed
            if docker ps -a | grep -q loan-api; then
              echo "Force removing all remaining loan-api containers..."
              docker rm -f $(docker ps -a | grep loan-api | awk '{print $1}') 2>&1 || true
              sleep 2
            fi
            
            # Verify no containers are running on port 8000
            if docker ps | grep -q ':8000'; then
              echo "Warning: Another container is using port 8000"
              docker ps | grep ':8000'
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 4: Get absolute paths"
            echo "=========================================="
            MODELS_ABS=$(cd ~/models && pwd)
            DATA_ABS=$(cd ~/data 2>/dev/null && pwd || echo "/tmp")
            echo "Models absolute path: $MODELS_ABS"
            echo "Data absolute path: $DATA_ABS"
            
            echo ""
            echo "=========================================="
            echo "STEP 5: Start new container with ABSOLUTE paths"
            echo "=========================================="
            docker run -d -p 8000:8000 \
              -v $MODELS_ABS:/app/models:ro \
              -v $DATA_ABS:/app/data:ro \
              --name loan-api \
              --restart unless-stopped \
              ${{ secrets.DOCKERHUB_USERNAME }}/loan-api:latest
            
            echo ""
            echo "=========================================="
            echo "STEP 6: Check container immediately"
            echo "=========================================="
            sleep 5
            docker ps -a | grep loan-api || echo "Container not found at all!"
            
            echo ""
            echo "=========================================="
            echo "STEP 7: Check container logs (even if exited)"
            echo "=========================================="
            CONTAINER_ID=$(docker ps -a | grep loan-api | awk '{print $1}' | head -1)
            if [ -n "$CONTAINER_ID" ]; then
              echo "Container ID: $CONTAINER_ID"
              echo "Container status:"
              docker ps -a | grep loan-api
              echo ""
              echo "Full container logs:"
              docker logs $CONTAINER_ID 2>&1 || docker logs loan-api 2>&1
            else
              echo "Cannot find container to check logs"
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 8: Wait longer and check again"
            echo "=========================================="
            sleep 25
            docker ps | grep loan-api && echo "✓ Container is running!" || echo "✗ Container is NOT running"
            
            echo ""
            echo "=========================================="
            echo "STEP 9: Verify file in container"
            echo "=========================================="
            docker exec loan-api ls -la /app/models/production/ 2>&1 || echo "Cannot access container"
            docker exec loan-api test -f /app/models/production/lightgbm_smote_high_performance.pkl && echo "✓ Model file accessible in container" || echo "✗ Model file NOT accessible in container"
            
            echo ""
            echo "=========================================="
            echo "STEP 10: Check Python can load model"
            echo "=========================================="
            docker exec loan-api python -c "import os; path='models/production/lightgbm_smote_high_performance.pkl'; print(f'File exists: {os.path.exists(path)}'); print(f'Absolute: {os.path.abspath(path)}')" 2>&1 || echo "Cannot test Python"
            
            echo ""
            echo "=========================================="
            echo "STEP 11: Test API endpoints"
            echo "=========================================="
            sleep 5
            echo "Health check:"
            curl -s http://localhost:8000/health | python3 -m json.tool 2>&1 || curl -s http://localhost:8000/health
            echo ""
            echo "Model info:"
            curl -s http://localhost:8000/model/info | python3 -m json.tool 2>&1 || curl -s http://localhost:8000/model/info
            
            echo ""
            echo "=========================================="
            echo "FIX COMPLETE"
            echo "=========================================="
