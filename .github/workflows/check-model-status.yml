name: Check Model Status on EC2

on:
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check container and model status
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "=========================================="
            echo "STEP 1: Check if container is running"
            echo "=========================================="
            docker ps -a | grep loan-api || echo "No loan-api container found"
            
            echo ""
            echo "=========================================="
            echo "STEP 2: Check files on EC2 host"
            echo "=========================================="
            echo "Files in ~/models/production/:"
            ls -lah ~/models/production/ || echo "Directory doesn't exist"
            
            echo ""
            echo "=========================================="
            echo "STEP 3: Check container logs (last 100 lines)"
            echo "=========================================="
            if docker ps | grep -q loan-api; then
              docker logs loan-api --tail 100 2>&1
            else
              echo "Container is not running!"
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 4: Check if files accessible in container"
            echo "=========================================="
            if docker ps | grep -q loan-api; then
              echo "Checking /app/models/production/ in container:"
              docker exec loan-api ls -lah /app/models/production/ 2>&1 || echo "Cannot access container"
              
              echo ""
              echo "Checking if model file exists:"
              docker exec loan-api test -f /app/models/production/lightgbm_smote_high_performance.pkl && echo "✓ Model file EXISTS" || echo "✗ Model file NOT FOUND"
              
              echo ""
              echo "Checking Python can find the file:"
              docker exec loan-api python -c "import os; path='models/production/lightgbm_smote_high_performance.pkl'; print(f'File exists: {os.path.exists(path)}'); print(f'Absolute path: {os.path.abspath(path)}')" 2>&1 || echo "Cannot test Python"
            else
              echo "Container is not running - cannot check"
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 5: Check volume mounts"
            echo "=========================================="
            if docker ps | grep -q loan-api; then
              docker inspect loan-api | grep -A 20 "Mounts" || echo "Cannot inspect container"
            else
              echo "Container is not running"
            fi
            
            echo ""
            echo "=========================================="
            echo "STEP 6: Test API from inside EC2"
            echo "=========================================="
            curl -s http://localhost:8000/health | head -20 || echo "Health check failed"
            curl -s http://localhost:8000/model/info | head -20 || echo "Model info check failed"
