name: Fix Model - Direct EC2 Fix

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/fix-model-direct.yml'

jobs:
  fix-model:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 0
      
      - name: Setup SSH and upload files
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Upload model files
          echo "Uploading model files..."
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "mkdir -p ~/models/production && chmod 755 ~/models/production"
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/lightgbm_smote_high_performance.pkl $EC2_USER@$EC2_HOST:~/models/production/
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/metrics_smote_high_performance.json $EC2_USER@$EC2_HOST:~/models/production/
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/optimal_threshold_smote.json $EC2_USER@$EC2_HOST:~/models/production/
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no models/production/feature_names.json $EC2_USER@$EC2_HOST:~/models/production/
          
          echo "Verifying files uploaded..."
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "ls -lah ~/models/production/"
          
          echo "Running fix script on EC2..."
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            set -x
            
            echo "=========================================="
            echo "STEP 1: Check current state"
            echo "=========================================="
            echo "All containers:"
            docker ps -a
            
            echo ""
            echo "What's using port 8000:"
            sudo netstat -tlnp | grep 8000 || echo "Nothing found on port 8000"
            docker ps --filter "publish=8000" || echo "No Docker container on port 8000"
            
            echo ""
            echo "=========================================="
            echo "STEP 2: Stop and remove ALL containers"
            echo "=========================================="
            # Stop all containers
            docker stop $(docker ps -aq) 2>/dev/null || echo "No containers to stop"
            sleep 3
            
            # Remove all containers
            docker rm -f $(docker ps -aq) 2>/dev/null || echo "No containers to remove"
            sleep 2
            
            # Verify
            if [ $(docker ps -aq | wc -l) -gt 0 ]; then
              echo "WARNING: Containers still exist, forcing removal..."
              docker rm -f $(docker ps -aq) 2>/dev/null || true
            fi
            
            echo "✓ All containers removed"
            
            echo ""
            echo "=========================================="
            echo "STEP 3: Verify model files and paths"
            echo "=========================================="
            MODELS_DIR="$HOME/models"
            MODELS_ABS=$(cd "$MODELS_DIR" && pwd)
            echo "Models directory: $MODELS_ABS"
            
            echo "Files in models directory:"
            ls -lah "$MODELS_ABS/production/" || echo "ERROR: Directory not found!"
            
            MODEL_FILE="$MODELS_ABS/production/lightgbm_smote_high_performance.pkl"
            if [ ! -f "$MODEL_FILE" ]; then
              echo "✗ ERROR: Model file NOT FOUND at $MODEL_FILE"
              echo "Current directory: $(pwd)"
              echo "Home directory: $HOME"
              echo "Looking for files:"
              find ~ -name "lightgbm_smote_high_performance.pkl" 2>/dev/null | head -5
              exit 1
            fi
            
            echo "✓ Model file found: $MODEL_FILE"
            ls -lh "$MODEL_FILE"
            
            # Test file accessibility
            test -r "$MODEL_FILE" && echo "✓ File is readable" || echo "✗ File is NOT readable"
            
            echo ""
            echo "=========================================="
            echo "STEP 4: Pull latest Docker image"
            echo "=========================================="
            docker pull $DOCKERHUB_USERNAME/loan-api:latest || echo "Warning: Failed to pull image"
            
            echo ""
            echo "=========================================="
            echo "STEP 5: Start container with model mount"
            echo "=========================================="
            echo "Starting container with:"
            echo "  Image: $DOCKERHUB_USERNAME/loan-api:latest"
            echo "  Models mount: $MODELS_ABS:/app/models:ro"
            echo "  Port: 8000:8000"
            
            # Start container WITHOUT restart policy
            CONTAINER_ID=$(docker run -d \
              -p 8000:8000 \
              -v "$MODELS_ABS:/app/models:ro" \
              --name loan-api \
              $DOCKERHUB_USERNAME/loan-api:latest)
            
            echo "Container ID: $CONTAINER_ID"
            
            echo ""
            echo "=========================================="
            echo "STEP 6: Monitor container startup"
            echo "=========================================="
            sleep 5
            
            # Check if container is running
            if ! docker ps | grep -q loan-api; then
              echo "✗ ERROR: Container stopped immediately!"
              echo "Container logs:"
              docker logs loan-api 2>&1 || docker logs $CONTAINER_ID 2>&1
              exit 1
            fi
            
            echo "✓ Container is running"
            
            echo ""
            echo "=========================================="
            echo "STEP 7: Check container logs"
            echo "=========================================="
            echo "Last 50 lines of container logs:"
            docker logs loan-api 2>&1 | tail -50
            
            echo ""
            echo "=========================================="
            echo "STEP 8: Verify model file in container"
            echo "=========================================="
            echo "Listing /app/models/production/ in container:"
            docker exec loan-api ls -lah /app/models/production/ 2>&1 || echo "Cannot exec into container"
            
            echo ""
            echo "Checking if model file exists in container:"
            docker exec loan-api test -f /app/models/production/lightgbm_smote_high_performance.pkl && echo "✓ Model file exists in container" || echo "✗ Model file NOT in container"
            
            echo ""
            echo "Checking if model file is readable:"
            docker exec loan-api test -r /app/models/production/lightgbm_smote_high_performance.pkl && echo "✓ Model file is readable" || echo "✗ Model file NOT readable"
            
            echo ""
            echo "=========================================="
            echo "STEP 9: Wait for model to load (30 seconds)"
            echo "=========================================="
            sleep 30
            
            # Check logs again for model loading
            echo "Checking logs for model loading confirmation:"
            docker logs loan-api 2>&1 | grep -i "model" | tail -10
            
            echo ""
            echo "=========================================="
            echo "STEP 10: Test API from INSIDE EC2"
            echo "=========================================="
            echo "Testing /health endpoint:"
            HEALTH_RESPONSE=$(curl -s http://localhost:8000/health || echo "FAILED")
            echo "$HEALTH_RESPONSE"
            
            if echo "$HEALTH_RESPONSE" | grep -q '"model_loaded":true'; then
              echo "✓ Model is loaded!"
            else
              echo "✗ Model NOT loaded - checking logs:"
              docker logs loan-api 2>&1 | tail -30
            fi
            
            echo ""
            echo "Testing /model/info endpoint:"
            MODEL_INFO=$(curl -s http://localhost:8000/model/info || echo "FAILED")
            echo "$MODEL_INFO" | head -20
            
            echo ""
            echo "=========================================="
            echo "STEP 11: Test from OUTSIDE EC2"
            echo "=========================================="
            EXTERNAL_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 || echo "Cannot get IP")
            echo "EC2 Public IP: $EXTERNAL_IP"
            echo ""
            echo "Testing external /health endpoint:"
            EXTERNAL_HEALTH=$(curl -s http://$EXTERNAL_IP:8000/health || echo "FAILED")
            echo "$EXTERNAL_HEALTH"
            
            if echo "$EXTERNAL_HEALTH" | grep -q '"model_loaded":true'; then
              echo "✓ External health check PASSED - model is loaded!"
            else
              echo "✗ External health check FAILED"
            fi
            
            echo ""
            echo "Testing external /model/info endpoint:"
            EXTERNAL_INFO=$(curl -s http://$EXTERNAL_IP:8000/model/info || echo "FAILED")
            echo "$EXTERNAL_INFO" | head -20
            
            echo ""
            echo "=========================================="
            echo "STEP 12: Verify only ONE container running"
            echo "=========================================="
            RUNNING_COUNT=$(docker ps | grep -c loan-api || echo "0")
            echo "Running loan-api containers: $RUNNING_COUNT"
            if [ "$RUNNING_COUNT" != "1" ]; then
              echo "WARNING: Expected 1 container, found $RUNNING_COUNT"
              docker ps
            fi
            
            echo ""
            echo "=========================================="
            echo "FINAL STATUS"
            echo "=========================================="
            echo "Container status:"
            docker ps | grep loan-api || echo "NOT RUNNING"
            
            echo ""
            echo "Port 8000 status:"
            sudo netstat -tlnp | grep 8000 || echo "Nothing on port 8000"
            
            echo ""
            echo "Model file:"
            ls -lh "$MODEL_FILE"
            
            echo ""
            echo "Container logs (last 10 lines):"
            docker logs loan-api 2>&1 | tail -10
ENDSSH

      - name: Final verification from GitHub Actions
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting 5 seconds before final test..."
          sleep 5
          
          echo ""
          echo "Testing API from GitHub Actions:"
          HEALTH=$(curl -s http://$EC2_HOST:8000/health || echo "FAILED")
          echo "Health response: $HEALTH"
          
          if echo "$HEALTH" | grep -q '"model_loaded":true'; then
            echo "✓ API is working correctly!"
            exit 0
          else
            echo "✗ API still reporting model not loaded"
            exit 1
          fi
